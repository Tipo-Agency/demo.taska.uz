# Техническое задание: Модуль «Склад» (taska.uz)

## 1. Общие сведения

### 1.1. Назначение
Модуль «Склад» предназначен для учёта товарно-материальных ценностей (ТМЦ): номенклатура, склады, подразделения, операции оприходования, перемещения, списания и ревизии остатков.

### 1.2. Основной цвет системы
- **#267022** — основной зелёный цвет бренда taska.uz (кнопки, акценты, иконки модуля).

### 1.3. Состав модуля
| Компонент        | Описание |
|------------------|----------|
| Подразделения    | Организационные единицы (цех, офис, филиал), к которым привязаны склады |
| Склады           | Места хранения с привязкой к подразделению |
| Номенклатура     | Справочник товаров/материалов (код, название, ед. изм., категория) |
| Остатки          | Рассчитываемые остатки по складам и номенклатуре |
| Движения         | Журнал операций: оприходование, перемещение, списание, корректировка |
| Ревизии          | Документы инвентаризации с фиксацией фактических остатков и проведением в виде корректировок |

---

## 2. Подразделения

### 2.1. Назначение
Подразделения задают структуру организации. Склад привязывается к подразделению (опционально). Справочник подразделений общий с модулем «Финансы» и «HR».

### 2.2. Поля (используются из типа `Department`)
- **id** (string) — уникальный идентификатор
- **name** (string) — название
- **headId** (string, опционально) — руководитель
- **description** (string, опционально)

### 2.3. Поведение в модуле Склад
- В фильтрах и при создании склада доступен выбор подразделения.
- Остатки и движения можно фильтровать по подразделению (через склады этого подразделения).

---

## 3. Склады

### 3.1. Назначение
Склад — место хранения. Остатки ведутся в разрезе «склад + номенклатура».

### 3.2. Поля (тип `Warehouse`)
| Поле           | Тип    | Обязательное | Описание |
|----------------|--------|--------------|----------|
| id             | string | да           | Уникальный идентификатор |
| name           | string | да           | Название склада |
| departmentId   | string | нет          | ID подразделения |
| location       | string | нет          | Адрес/локация |
| isDefault      | boolean| нет          | Склад по умолчанию для операций |
| isArchived     | boolean| нет          | Мягкое удаление (скрыт из выбора) |

### 3.3. Операции
- Создание, редактирование, архивирование склада.
- В списке и в операциях отображаются только неархивные склады.

---

## 4. Номенклатура

### 4.1. Назначение
Справочник наименований товаров/материалов. Используется во всех операциях и в остатках.

### 4.2. Поля (тип `InventoryItem`)
| Поле     | Тип    | Обязательное | Описание |
|----------|--------|--------------|----------|
| id       | string | да           | Уникальный идентификатор |
| sku      | string | нет          | Код/артикул |
| name     | string | да           | Название |
| unit     | string | да           | Единица измерения (шт, кг, м, л и т.д.) |
| category | string | нет          | Категория/группа |
| notes    | string | нет          | Комментарий |
| isArchived | boolean | нет        | Мягкое удаление |

### 4.4. Операции
- Создание, редактирование, архивирование номенклатуры.
- В выборах при проведении операций — только неархивная номенклатура.

---

## 5. Движения (операции по складу)

### 5.1. Типы движений (`StockMovementType`)
| Тип          | Код         | Описание |
|-------------|-------------|----------|
| Оприходование | receipt   | Поступление на склад (внешний приход). Только склад назначения. |
| Перемещение | transfer    | Перемещение между складами. Склад-источник и склад назначения. |
| Списание    | writeoff    | Расход со склада. Только склад-источник. |
| Корректировка | adjustment | Изменение остатка (в т.ч. по результатам ревизии). Только склад назначения; количество может быть положительным или отрицательным для выравнивания. |

### 5.2. Поля документа движения (тип `StockMovement`)
| Поле             | Тип     | Описание |
|------------------|---------|----------|
| id               | string  | Уникальный идентификатор |
| type             | StockMovementType | Тип операции |
| date             | string  | Дата (ISO) |
| fromWarehouseId  | string? | Склад-источник (для transfer, writeoff) |
| toWarehouseId    | string? | Склад назначения (для receipt, transfer, adjustment) |
| items            | StockMovementItem[] | Список строк: номенклатура + количество [+ цена] |
| reason           | string? | Основание/комментарий |
| createdByUserId  | string  | Кто создал |

### 5.3. Строка движения (`StockMovementItem`)
| Поле    | Тип    | Описание |
|---------|--------|----------|
| itemId  | string | ID номенклатуры |
| quantity| number | Количество (для adjustment может быть отрицательным) |
| price   | number?| Цена (опционально, для учёта стоимости) |

### 5.4. Правила проведения
- **receipt**: увеличивает остаток на `toWarehouseId` по каждой номенклатуре в `items`.
- **writeoff**: уменьшает остаток на `fromWarehouseId`; остаток не может стать отрицательным (валидация при проведении).
- **transfer**: уменьшает остаток на `fromWarehouseId`, увеличивает на `toWarehouseId`; оттуда же проверка неотрицательности.
- **adjustment**: изменяет остаток на `toWarehouseId` на величину `quantity` (плюс/минус). Используется при ревизии для приведения учётного остатка к фактическому.

---

## 6. Остатки

### 6.1. Назначение
Остатки по складам и номенклатуре не хранятся отдельной сущностью, а **рассчитываются** по всем проведённым движениям.

### 6.2. Тип `StockBalance`
| Поле        | Тип    | Описание |
|-------------|--------|----------|
| warehouseId | string | ID склада |
| itemId      | string | ID номенклатуры |
| quantity    | number | Количество |

### 6.3. Алгоритм расчёта
- Обход всех движений в хронологическом порядке.
- По каждому типу: receipt/adjustment — прибавление к складу назначения; writeoff — вычитание со склада источника; transfer — вычитание с источника, прибавление на назначение.
- Итог по парам (warehouseId, itemId) даёт текущие остатки.

---

## 7. Ревизии

### 7.1. Назначение
Ревизия (инвентаризация) — документ, фиксирующий **фактические** остатки на складе на дату. После ввода фактических количеств система формирует движения типа **adjustment**, чтобы привести учётные остатки к фактическим.

### 7.2. Тип `InventoryRevision`
| Поле           | Тип     | Описание |
|----------------|---------|----------|
| id             | string  | Уникальный идентификатор |
| number         | string  | Номер документа (например, РЕВ-001) |
| warehouseId    | string  | Склад |
| date           | string  | Дата ревизии (ISO) |
| status         | 'draft' \| 'posted' | Черновик / Проведён |
| lines          | InventoryRevisionLine[] | Строки: номенклатура, учётный остаток, фактический остаток |
| reason         | string? | Комментарий |
| createdByUserId| string  | Кто создал |
| postedAt       | string? | Дата/время проведения (ISO) |

### 7.3. Строка ревизии `InventoryRevisionLine`
| Поле       | Тип    | Описание |
|------------|--------|----------|
| itemId     | string | ID номенклатуры |
| quantitySystem | number | Учётный остаток на момент создания ревизии |
| quantityFact | number | Фактический остаток (вводит пользователь) |

Разница `quantityFact - quantitySystem` определяет величину корректировки (положительную или отрицательную) при проведении.

### 7.4. Сценарий работы
1. Пользователь создаёт ревизию: выбирает склад, дату, при необходимости подтягивает текущие остатки по складу в строки (учётные).
2. Вводит фактические остатки по строкам.
3. Нажимает «Провести». Система для каждой строки, где `quantityFact !== quantitySystem`, создаёт движение типа **adjustment** с одной строкой: `itemId`, `quantity: quantityFact - quantitySystem`, `toWarehouseId` = склад ревизии. Все движения датируются датой ревизии. Статус ревизии переводится в `posted`, заполняется `postedAt`.
4. Проведённую ревизию нельзя редактировать (только просмотр).

---

## 8. API и хранилище

### 8.1. Коллекции (localStorage / localStoreService)
- **warehouses** — склады
- **inventoryItems** — номенклатура
- **stockMovements** — движения
- **inventoryRevisions** — ревизии

Остатки не хранятся, вычисляются на фронте по движениям.

### 8.2. Эндпоинты (api.inventory)
| Метод | Описание |
|-------|----------|
| getWarehouses() | Список складов |
| updateWarehouses(warehouses) | Сохранить склады |
| getItems() | Список номенклатуры |
| updateItems(items) | Сохранить номенклатуру |
| getMovements() | Список движений |
| updateMovements(movements) | Сохранить движения |
| getRevisions() | Список ревизий |
| updateRevisions(revisions) | Сохранить ревизии |

---

## 9. UI модуля «Склад»

### 9.1. Вкладки
1. **Остатки** — выбор подразделения и склада, таблица остатков (код, название, ед. изм., остаток). Кнопка добавления склада.
2. **Номенклатура** — справочник: код, название, ед. изм., категория, комментарий. Создание/редактирование/архивирование.
3. **Журнал** — список движений (дата, тип, со склада, на склад, основание). Форма создания операции: тип (оприходование / перемещение / списание / корректировка), склады, номенклатура, количество, комментарий.
4. **Ревизии** — список ревизий (номер, склад, дата, статус). Создание ревизии: склад, дата, подтягивание остатков, ввод фактических количеств, проведение.

### 9.2. Цвета и бренд
- Основной акцент модуля: **#267022** (кнопки «Добавить», «Провести», активные табы, иконка модуля).
- Наименование системы в шапке и логотипе: **taska.uz**.

---

## 10. Интеграции

- **Подразделения**: справочник из модуля «Финансы»/«HR» (departments).
- При необходимости в будущем: уведомления о низких остатках, выгрузка в отчёты.

---

*Документ: ТЗ модуля «Склад», система taska.uz. Основной цвет #267022.*
