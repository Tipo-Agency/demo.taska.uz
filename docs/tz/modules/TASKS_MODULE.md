# Техническое задание: Модуль задач (Tasks Module)

## 1. Общая информация

### 1.1. Назначение
Модуль задач предназначен для управления задачами, идеями и функциями проекта. Поддерживает различные типы задач, статусы, приоритеты, назначение исполнителей и интеграцию с другими модулями.

### 1.2. Типы задач

Модуль поддерживает следующие типы задач (через поле `entityType`):

1. **task** - Обычная задача
2. **idea** - Идея (из беклога)
3. **feature** - Функция (из функционала)
4. **purchase_request** - Заявка на покупку (интеграция с Finance модулем)

## 2. Функциональные требования

### 2.1. Создание задачи

#### 2.1.1. Обязательные поля
- **title** (string) - Название задачи
- **status** (string) - Статус задачи (из коллекции statuses)
- **priority** (string) - Приоритет (из коллекции priorities)
- **startDate** (string) - Дата начала (YYYY-MM-DD), по умолчанию дата создания
- **endDate** (string) - Дата окончания (YYYY-MM-DD), по умолчанию дата создания
- **tableId** (string) - ID таблицы/проекта
- **entityType** (string) - Тип задачи ('task' | 'idea' | 'feature' | 'purchase_request')

#### 2.1.2. Опциональные поля
- **description** (string) - Описание задачи
- **assigneeId** (string | null) - ID исполнителя
- **assigneeIds** (string[]) - ID нескольких исполнителей
- **projectId** (string | null) - ID проекта
- **category** (string) - Категория задачи
- **contentPostId** (string) - ID поста контент-плана (связь с Content модулем)
- **processId** (string) - ID бизнес-процесса
- **processInstanceId** (string) - ID экземпляра процесса
- **stepId** (string) - ID шага процесса
- **dealId** (string) - ID сделки (связь с CRM модулем)
- **source** (string) - Источник ('Задача', 'Беклог', 'Функционал')

#### 2.1.3. Автоматические поля
- **id** (string) - Генерируется автоматически
- **createdAt** (string) - ISO дата создания
- **updatedAt** (string) - ISO дата обновления
- **createdByUserId** (string) - ID создателя

### 2.2. Редактирование задачи

#### 2.2.1. Изменение статуса
- При изменении статуса создается activity log
- Отправляется Telegram уведомление (если настроено)
- Запускается автоматизация (если настроена)

#### 2.2.2. Изменение исполнителя
- При изменении исполнителя создается activity log
- Отправляется Telegram уведомление новому исполнителю (если настроено)

#### 2.2.3. Изменение дат
- Для задач (`entityType: 'task'`) даты обязательны
- Для идей и функций даты опциональны
- При изменении даты окончания проверяется просрочка

### 2.3. Удаление задачи

#### 2.3.1. Мягкое удаление
- Поле `isArchived: true` вместо физического удаления
- Архивные задачи не отображаются в основных списках
- Восстановление через функцию `restoreTask`

#### 2.3.2. Полное удаление
- Доступно только администраторам
- Удаляет задачу и все связанные данные (комментарии, вложения)

### 2.4. Комментарии

#### 2.4.1. Добавление комментария
- Текст комментария (обязательно)
- Автоматически добавляется автор и дата
- Поддержка вложений (файлы, документы)

#### 2.4.2. Типы комментариев
- **internal** - Внутренний комментарий
- **telegram_in** - Входящее сообщение из Telegram
- **telegram_out** - Исходящее сообщение в Telegram

### 2.5. Вложения

#### 2.5.1. Типы вложений
- **file** - Файл (загружается в Firebase Storage)
- **doc** - Документ (ссылка на документ из Content модуля)

#### 2.5.2. Ограничения
- Максимальный размер файла: 10 MB
- Поддерживаемые форматы: изображения, PDF, документы Office

## 3. Представления (Views)

### 3.1. Табличное представление (Table View)

#### 3.1.1. Колонки
- Название задачи
- Статус (с цветом)
- Приоритет (с цветом)
- Исполнитель
- Проект
- Дата начала
- Дата окончания
- Действия (редактировать, удалить)

#### 3.1.2. Фильтры
- По статусу
- По исполнителю
- По проекту
- По дате
- Скрыть выполненные задачи

#### 3.1.3. Сортировка
- По дате создания
- По дате окончания
- По приоритету
- По статусу

### 3.2. Канбан-доска (Kanban View)

#### 3.2.1. Колонки
- Колонки соответствуют статусам задач
- Задачи можно перетаскивать между колонками (drag & drop)
- При перетаскивании автоматически обновляется статус

#### 3.2.2. Отображение карточек
- Название задачи
- Приоритет (цветная метка)
- Исполнитель (аватар)
- Дата окончания
- Количество комментариев

### 3.3. Диаграмма Ганта (Gantt View)

#### 3.3.1. Временная шкала
- Ось X: даты (дни, недели, месяцы)
- Ось Y: задачи (группировка по проектам)

#### 3.3.2. Визуализация
- Полосы задач с датами начала и окончания
- Зависимости между задачами
- Критический путь

### 3.4. Представление функционала (Functionality View)

#### 3.4.1. Категории функций
- Установка счетчиков
- Настройка под SEO
- Фичи
- Бэкенд
- Серверная инфраструктура

#### 3.4.2. Группировка
- По проектам (вкладки)
- По категориям
- По статусам

### 3.5. Представление беклога (Backlog View)

#### 3.5.1. Идеи
- Отображаются только идеи (`entityType: 'idea'`)
- Фильтрация по таблице беклога
- Возможность конвертации идеи в задачу

## 4. Интеграции

### 4.1. Интеграция с Content модулем
- Связь задачи с постом контент-плана (`contentPostId`)
- При создании задачи из поста автоматически заполняется `contentPostId`

### 4.2. Интеграция с CRM модулем
- Связь задачи со сделкой (`dealId`)
- При создании задачи из сделки автоматически заполняется `dealId`

### 4.3. Интеграция с HR модулем (Бизнес-процессы)
- Связь задачи с бизнес-процессом (`processId`, `processInstanceId`, `stepId`)
- Автоматическое создание задач при запуске процесса
- Автоматическое обновление статуса процесса при изменении статуса задачи

### 4.4. Интеграция с Finance модулем
- Заявки на покупку (`entityType: 'purchase_request'`)
- Связь с отделом (`departmentId`)
- Связь с категорией финансов (`categoryId`)
- Сумма заявки (`amount`)

## 5. Уведомления

### 5.1. События для уведомлений
- Создание задачи
- Изменение статуса
- Назначение исполнителя
- Добавление комментария
- Приближение дедлайна

### 5.2. Каналы уведомлений
- Activity Logs (всегда)
- Telegram (по настройкам пользователя)

## 6. Автоматизация

### 6.1. Правила автоматизации
- При создании задачи
- При изменении статуса
- При назначении исполнителя
- При добавлении комментария
- При приближении дедлайна

### 6.2. Действия автоматизации
- Отправка Telegram сообщения
- Запрос на согласование
- Назначение задачи
- Изменение статуса

## 7. Технические детали

### 7.1. Компоненты
- `TaskModal` - Модальное окно создания/редактирования задачи
- `TasksView` - Основной компонент представления задач
- `TableView` - Табличное представление
- `KanbanBoard` - Канбан-доска
- `GanttView` - Диаграмма Ганта
- `FunctionalityView` - Представление функционала

### 7.2. Хуки
- `useTaskLogic` - Основная логика работы с задачами
- `useTaskFilters` - Фильтрация задач
- `useTaskSorting` - Сортировка задач

### 7.3. API Endpoints
- `GET /api/tasks` - Получить все задачи
- `POST /api/tasks` - Создать задачу
- `PUT /api/tasks/:id` - Обновить задачу
- `DELETE /api/tasks/:id` - Удалить задачу
- `POST /api/tasks/:id/comments` - Добавить комментарий
- `POST /api/tasks/:id/attachments` - Добавить вложение

### 7.4. Коллекции Firestore
- `tasks` - Задачи
- `projects` - Проекты
- `statuses` - Статусы
- `priorities` - Приоритеты
