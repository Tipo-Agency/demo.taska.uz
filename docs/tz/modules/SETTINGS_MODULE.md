# Техническое задание: Модуль настроек (Settings Module)

## 1. Общая информация

### 1.1. Назначение
Модуль настроек предназначен для управления системными настройками, таблицами, уведомлениями, автоматизацией и пользователями.

### 1.2. Компоненты модуля
- **Таблицы** - Управление таблицами/проектами
- **Уведомления** - Настройки уведомлений
- **Автоматизация** - Правила автоматизации
- **Пользователи** - Управление пользователями
- **Telegram бот** - Настройки Telegram бота

## 2. Таблицы (Tables)

### 2.1. Создание таблицы

#### 2.1.1. Обязательные поля
- **name** (string) - Название таблицы
- **type** (string) - Тип таблицы

#### 2.1.2. Типы таблиц
- **tasks** - Таблица задач
- **docs** - Таблица документов
- **meetings** - Таблица встреч
- **content-plan** - Контент-план
- **backlog** - Беклог (идеи)
- **functionality** - Функционал

#### 2.1.3. Опциональные поля
- **isSystem** (boolean) - Системная таблица (нельзя удалить)

### 2.2. Управление таблицами
- Создание таблицы
- Редактирование таблицы
- Удаление таблицы (кроме системных)
- Мягкое удаление (архив)
- Восстановление из архива

## 3. Уведомления (Notifications)

### 3.1. Настройки уведомлений

#### 3.1.1. Типы уведомлений
- **newTask** - Новая задача
- **statusChange** - Изменение статуса
- **taskAssigned** - Назначение задачи
- **taskComment** - Комментарий к задаче
- **taskDeadline** - Приближение дедлайна
- **dealCreated** - Новая сделка
- **dealStatusChanged** - Изменение стадии сделки
- **clientCreated** - Новый клиент
- **contractCreated** - Новый договор
- **docCreated** - Новый документ
- **meetingCreated** - Новая встреча
- **purchaseRequestCreated** - Новая заявка на покупку

#### 3.1.2. Настройки для каждого типа
```typescript
{
  telegramPersonal: boolean;  // Уведомления в личный чат
  telegramGroup: boolean;     // Уведомления в группу
}
```

### 3.2. Глобальные настройки
- **telegramGroupChatId** (string) - ID группового чата для уведомлений
- **defaultFunnelId** (string) - ID основной воронки для лидов

## 4. Автоматизация (Automation Rules)

### 4.1. Создание правила

#### 4.1.1. Обязательные поля
- **name** (string) - Название правила
- **isActive** (boolean) - Активно ли правило
- **module** (string) - Модуль: 'tasks' | 'docs' | 'meetings' | 'content' | 'finance' | 'crm' | 'employees' | 'bpm'
- **trigger** (string) - Тип триггера (TriggerType)
- **action** (object) - Действие

#### 4.1.2. Типы триггеров
- **task_created** - Создание задачи
- **task_status_changed** - Изменение статуса задачи
- **task_assigned** - Назначение задачи
- **task_comment** - Комментарий к задаче
- **task_deadline** - Приближение дедлайна
- **deal_created** - Создание сделки
- **deal_status_changed** - Изменение стадии сделки
- И другие...

#### 4.1.3. Условия (conditions)
```typescript
{
  moduleId?: string;      // ID модуля
  statusTo?: string;     // Статус для триггера изменения статуса
  statusFrom?: string;   // Исходный статус
  priority?: string;     // Приоритет
  departmentId?: string; // ID отдела
  categoryId?: string;   // ID категории
}
```

#### 4.1.4. Действия (action)
```typescript
{
  type: 'telegram_message' | 'approval_request' | 'assign_task' | 'change_status';
  template?: string;              // Шаблон сообщения
  targetUser: 'assignee' | 'creator' | 'admin' | 'specific' | 'manager';
  specificUserId?: string;         // ID конкретного пользователя
  buttons?: TelegramButton[];      // Кнопки для Telegram
  approvalType?: string;           // Тип согласования
  approvalEntityId?: string;       // ID сущности для согласования
}
```

### 4.2. Управление правилами
- Создание правила
- Редактирование правила
- Активация/деактивация правила
- Удаление правила

## 5. Пользователи (Users)

### 5.1. Управление пользователями
- Просмотр списка пользователей
- Создание пользователя
- Редактирование пользователя
- Смена пароля
- Мягкое удаление (архив)
- Восстановление из архива

### 5.2. Роли
- **ADMIN** - Администратор (полный доступ)
- **EMPLOYEE** - Сотрудник (ограниченный доступ)

## 6. Telegram бот

### 6.1. Настройки бота
- **botToken** (string) - Токен Telegram бота
- Сохранение токена в localStorage

## 7. Activity Logs

### 7.1. Логи активности
- Все действия пользователей логируются
- Отображаются в разделе "Уведомления"
- Фильтрация по пользователю, типу действия, дате
- Отметка о прочтении

## 8. Технические детали

### 8.1. Компоненты
- `SettingsView` - Основной компонент настроек
- `AutomationSettings` - Настройки автоматизации
- `NotificationSettings` - Настройки уведомлений
- `TablesSettings` - Управление таблицами
- `UsersSettings` - Управление пользователями

### 8.2. API Endpoints
- `GET /api/tables` - Получить все таблицы
- `POST /api/tables` - Создать таблицу
- `PUT /api/tables/:id` - Обновить таблицу
- `DELETE /api/tables/:id` - Удалить таблицу
- `GET /api/notificationPrefs` - Получить настройки уведомлений
- `PUT /api/notificationPrefs` - Обновить настройки уведомлений
- `GET /api/automationRules` - Получить все правила
- `POST /api/automationRules` - Создать правило
- `GET /api/users` - Получить всех пользователей

### 8.3. Коллекции Firestore
- `tables` - Таблицы
- `notificationPrefs` - Настройки уведомлений
- `automationRules` - Правила автоматизации
- `users` - Пользователи
- `activity` - Логи активности
