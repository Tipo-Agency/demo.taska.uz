# Техническое задание: Модуль CRM

## 1. Общая информация

### 1.1. Назначение
Модуль CRM предназначен для управления клиентами, сделками, договорами и воронками продаж. Поддерживает интеграцию с внешними источниками (Telegram, Instagram, сайты).

### 1.2. Компоненты модуля
- **Клиенты** - База клиентов
- **Сделки** - Управление сделками через воронки продаж
- **Договоры** - Договоры с ежемесячными платежами
- **Разовые сделки** - Разовые продажи
- **Дебиторская задолженность** - Управление задолженностями

## 2. Клиенты (Clients)

### 2.1. Создание клиента

#### 2.1.1. Обязательные поля
- **name** (string) - Название клиента

#### 2.1.2. Опциональные поля
- **contactPerson** (string) - Контактное лицо
- **phone** (string) - Телефон
- **email** (string) - Email
- **telegram** (string) - Telegram username
- **instagram** (string) - Instagram username
- **companyName** (string) - Название компании
- **companyInfo** (string) - Информация о компании
- **notes** (string) - Заметки
- **funnelId** (string) - ID воронки продаж

### 2.2. Управление клиентами
- Просмотр списка клиентов
- Поиск по имени, телефону, email
- Редактирование клиента
- Мягкое удаление (архив)
- Восстановление из архива

## 3. Сделки (Deals)

### 3.1. Создание сделки

#### 3.1.1. Обязательные поля
- **title** (string) - Название сделки
- **amount** (number) - Сумма сделки
- **currency** (string) - Валюта ('UZS', 'USD', etc.)
- **stage** (string) - ID стадии воронки
- **assigneeId** (string) - ID ответственного

#### 3.1.2. Опциональные поля
- **clientId** (string) - ID клиента
- **contactName** (string) - Имя контакта (для лидов без клиента)
- **funnelId** (string) - ID воронки продаж
- **source** (string) - Источник ('instagram', 'telegram', 'site', 'manual', 'recommendation', 'vk')
- **telegramChatId** (string) - ID чата в Telegram
- **telegramUsername** (string) - Username в Telegram
- **projectId** (string) - Вид услуг (модуль/проект)
- **notes** (string) - Комментарии к сделке
- **comments** (Comment[]) - Комментарии

### 3.2. Управление сделками
- Просмотр сделок в воронке продаж (канбан)
- Перетаскивание между стадиями
- Создание задачи из сделки
- Создание клиента из сделки
- Чат с лидом через Telegram (если есть telegramChatId)
- Фильтрация по воронке, стадии, ответственному
- Поиск по названию, клиенту, сумме

### 3.3. Интеграция с источниками

#### 3.3.1. Telegram
- Автоматическое создание лида из сообщения Telegram
- Сохранение telegramChatId для чата
- Синхронизация сообщений

#### 3.3.2. Instagram
- Автоматическое создание лида из комментария Instagram
- Синхронизация через Meta Graph API

#### 3.3.3. Сайты
- Создание лида из формы на сайте
- Webhook для получения данных

## 4. Воронки продаж (Sales Funnels)

### 4.1. Создание воронки

#### 4.1.1. Обязательные поля
- **name** (string) - Название воронки
- **stages** (FunnelStage[]) - Стадии воронки

#### 4.1.2. Стадии воронки
```typescript
{
  id: string;
  label: string;
  color: string;  // CSS класс цвета
}
```

### 4.2. Настройки источников

#### 4.2.1. Instagram
- **enabled** (boolean) - Включен ли источник
- **instagramAccountId** (string) - ID Instagram аккаунта
- **accessToken** (string) - Access Token для Meta Graph API
- **pageId** (string) - ID Facebook страницы
- **lastSyncAt** (string) - Время последней синхронизации

#### 4.2.2. Telegram
- **enabled** (boolean) - Включен ли источник
- **botToken** (string) - Токен Telegram бота
- **webhookUrl** (string) - URL вебхука
- **lastSyncAt** (string) - Время последней синхронизации

## 5. Договоры (Contracts)

### 5.1. Создание договора

#### 5.1.1. Обязательные поля
- **clientId** (string) - ID клиента
- **number** (string) - Номер договора
- **amount** (number) - Сумма договора
- **currency** (string) - Валюта
- **description** (string) - Описание услуги
- **startDate** (string) - Дата начала договора
- **endDate** (string) - Дата окончания договора
- **paymentDay** (number) - День месяца для оплаты (1-31)

#### 5.1.2. Статусы договора
- **pending** - Ожидает оплаты
- **active** - Активен
- **paid** - Оплачен
- **overdue** - Просрочен
- **completed** - Завершен

## 6. Разовые сделки (One-Time Deals)

### 6.1. Создание разовой сделки

#### 6.1.1. Обязательные поля
- **clientId** (string) - ID клиента
- **number** (string) - Номер сделки
- **amount** (number) - Сумма
- **currency** (string) - Валюта
- **description** (string) - Описание
- **date** (string) - Дата сделки

#### 6.1.2. Статусы
- **pending** - Ожидает оплаты
- **paid** - Оплачена
- **overdue** - Просрочена

## 7. Дебиторская задолженность (Accounts Receivable)

### 7.1. Создание записи о задолженности

#### 7.1.1. Обязательные поля
- **clientId** (string) - ID клиента
- **dealId** (string) - ID сделки (договора или продажи)
- **amount** (number) - Сумма задолженности
- **currency** (string) - Валюта
- **dueDate** (string) - Срок погашения (YYYY-MM-DD)
- **description** (string) - Описание

#### 7.1.2. Статусы
- **current** - Текущая
- **overdue** - Просроченная
- **paid** - Погашена

### 7.2. Управление задолженностью
- Автоматическое определение просроченных задолженностей
- Отметка о погашении
- История платежей

## 8. Интеграции

### 8.1. Интеграция с Tasks модулем
- Создание задачи из сделки
- Связь задачи со сделкой (`dealId`)

### 8.2. Интеграция с Notifications модулем
- Уведомления о новых сделках
- Уведомления об изменении стадии
- Уведомления о просроченных задолженностях

### 8.3. Интеграция с Telegram ботом
- Уведомления о новых лидах
- Чат с лидом через бота
- Управление сделками через бота

## 9. Технические детали

### 9.1. Компоненты
- `SalesFunnelView` - Представление воронки продаж (канбан)
- `ClientsView` - Представление клиентов
- `DealModal` - Модальное окно создания/редактирования сделки
- `ClientModal` - Модальное окно создания/редактирования клиента
- `ContractModal` - Модальное окно создания/редактирования договора

### 9.2. API Endpoints
- `GET /api/clients` - Получить всех клиентов
- `POST /api/clients` - Создать клиента
- `PUT /api/clients/:id` - Обновить клиента
- `DELETE /api/clients/:id` - Удалить клиента
- `GET /api/deals` - Получить все сделки
- `POST /api/deals` - Создать сделку
- `PUT /api/deals/:id` - Обновить сделку
- `GET /api/funnels` - Получить все воронки
- `POST /api/funnels` - Создать воронку

### 9.3. Коллекции Firestore
- `clients` - Клиенты
- `deals` - Сделки
- `salesFunnels` - Воронки продаж
- `accountsReceivable` - Дебиторская задолженность
