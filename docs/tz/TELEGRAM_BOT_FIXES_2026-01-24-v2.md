# Критические исправления Telegram бота - 2026-01-24 (v2)

## Выполненные исправления

### 1. ✅ ИСПРАВЛЕНА ФИЛЬТРАЦИЯ ЗАДАЧ

**Проблема:** Задачи на сегодня и просроченные не показывались, хотя задачи были в системе.

**Причина:** 
- Неправильная нормализация дат (дата могла содержать время)
- Неправильное сравнение дат в функции `is_overdue`

**Исправления:**
- Добавлена нормализация дат в `get_today_tasks` и `get_overdue_tasks`
- Улучшена функция `is_overdue` в `utils.py` - теперь обрабатывает разные форматы дат
- Добавлено подробное логирование для отладки

**Файлы:**
- `telegram-bot/tasks.py` - функции `get_today_tasks` и `get_overdue_tasks`
- `telegram-bot/utils.py` - функция `is_overdue`

**Изменения:**
```python
# Нормализация даты перед сравнением
if 'T' in end_date:
    end_date = end_date.split('T')[0]
elif ' ' in end_date:
    end_date = end_date.split(' ')[0]
```

---

### 2. ✅ УБРАНЫ НЕНУЖНЫЕ НАСТРОЙКИ УВЕДОМЛЕНИЙ

**Проблема:** В настройках уведомлений были лишние опции.

**Исправления:**
- Убрано "Назначение задачи" (`taskAssigned`)
- Убрано "Дедлайн задачи" (`taskDeadline`)
- Оставлено только:
  - Новая задача
  - Изменение статуса
  - Комментарий к задаче

**Файлы:**
- `telegram-bot/bot.py` - функция `settings_notif_tasks`

---

### 3. ✅ ИСПРАВЛЕНА КНОПКА "КОММЕНТАРИЙ"

**Проблема:** Кнопка "Комментарий" не отрабатывала.

**Исправления:**
- Исправлена логика определения категории в `settings_toggle_notification`
- Теперь используется точное сравнение вместо `startswith` для `taskComment`

**Файлы:**
- `telegram-bot/bot.py` - функция `settings_toggle_notification`

**Изменения:**
```python
# Было:
if setting_name.startswith('newTask') or setting_name.startswith('statusChange') or setting_name.startswith('task'):

# Стало:
if setting_name in ['newTask', 'statusChange', 'taskComment']:
```

---

### 4. ✅ НАСТРОЙКИ ГРУППОВОГО ЧАТА ТОЛЬКО ДЛЯ АДМИНИСТРАТОРОВ

**Проблема:** Настройки группового чата были доступны всем пользователям.

**Исправления:**
- Добавлена проверка роли пользователя в `settings_notif_group`
- Если пользователь не администратор, показывается сообщение "❌ Доступно только администраторам"
- Проверка: `user.get('role') != 'ADMIN'`

**Файлы:**
- `telegram-bot/bot.py` - функция `settings_notif_group`

---

### 5. ✅ ВСЕ УВЕДОМЛЕНИЯ ВКЛЮЧЕНЫ ПО УМОЛЧАНИЮ

**Проблема:** Нужно было убедиться, что все уведомления активны по умолчанию.

**Исправления:**
- Убраны `taskAssigned` и `taskDeadline` из дефолтных настроек
- Все остальные уведомления имеют `telegramPersonal: True` по умолчанию

**Файлы:**
- `telegram-bot/bot.py` - функция `settings_notifications`

---

## Проблема с уведомлениями

**Проблема:** Уведомления не приходят в бот, даже когда галочки поставлены.

**Возможные причины:**
1. У пользователя не настроен `telegramUserId` в профиле
2. Уведомления отправляются через веб-приложение (`services/notificationService.ts`), а не через бота напрямую
3. Проблема с токеном бота или настройками

**Что проверить:**
1. У пользователя должен быть заполнен `telegramUserId` в профиле
2. В веб-приложении должны быть настроены токены бота
3. Проверить логи веб-приложения при создании задачи

**Решение:**
- Уведомления отправляются через `services/notificationService.ts` → `services/telegramService.ts`
- Бот не отправляет уведомления напрямую, он только получает их через веб-приложение
- Нужно проверить, что веб-приложение правильно вызывает `notifyTaskCreated`

---

## Тестирование

После исправлений необходимо проверить:

1. ✅ **Задачи на сегодня** - показываются задачи с `endDate` = сегодня
2. ✅ **Просроченные задачи** - показываются задачи с `endDate` < сегодня
3. ✅ **Настройки уведомлений** - только 3 опции (новая задача, изменение статуса, комментарий)
4. ✅ **Кнопка "Комментарий"** - переключается корректно
5. ✅ **Настройки группового чата** - доступны только администраторам
6. ⚠️ **Уведомления** - требуют дополнительной проверки настройки `telegramUserId`

---

## Файлы, измененные в этом обновлении

1. `telegram-bot/tasks.py` - исправлена фильтрация задач
2. `telegram-bot/utils.py` - улучшена функция `is_overdue`
3. `telegram-bot/bot.py` - убраны лишние настройки, добавлена проверка прав для группового чата
4. `docs/tz/TELEGRAM_BOT_TZ.md` - обновлено ТЗ
